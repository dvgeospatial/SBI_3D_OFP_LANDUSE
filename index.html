<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SBI: 3D Woodland Visualization</title>
  
  <!-- =========================================================
       LIBRARIES (Cesium 1.121)
       ========================================================= -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    /* --- BASE STYLES --- */
    body, html, #cesiumContainer { 
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; 
      background: #dcdcdc; font-family: sans-serif; 
    }

    /* --- POPUP TOOLTIP STYLES --- */
    #hoverPopup {
      display: none;
      position: absolute;
      z-index: 1000;
      background: rgba(30, 30, 30, 0.9);
      color: #fff;
      padding: 10px 15px;
      border-radius: 6px;
      pointer-events: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 14px;
      max-width: 300px;
      line-height: 1.4;
      transform: translate(15px, 15px);
    }
    
    #hoverPopup strong {
      display: block;
      margin-bottom: 4px;
      color: #4facfe;
      font-size: 15px;
    }

    /* --- UI PANEL STYLES --- */
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 100;
      background: rgba(255, 255, 255, 0.95); padding: 12px; border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2); width: 200px;
    }

    .layer-row { 
      display: flex; align-items: center; font-size: 13px; cursor: pointer; 
      margin-bottom: 5px; color: #333; flex-wrap: wrap; 
    }
    .layer-row input[type="checkbox"] { margin-right: 8px; cursor: pointer; }
    
    .time-machine-row {
        background-color: #f0f8ff;
        border: 1px solid #4682b4;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    .time-machine-row label {
        font-weight: bold;
        color: #000;
    }

    #loadingIndicator { 
        font-size: 11px; color: #666; margin-top: 5px; display: none; font-style: italic; 
    }

    /* --- LEGEND STYLES --- */
    #legendPanel {
      position: absolute; bottom: 30px; right: 10px;
      background: rgba(255, 255, 255, 0.95); padding: 10px;
      border-radius: 5px; z-index: 100; max-height: 400px;
      overflow-y: auto; width: 220px; display: none;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }
    .legend-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 12px; color: #333; }
    .legend-item i {
      width: 18px; height: 18px; float: left; margin-right: 8px;
      opacity: 0.8; border: 1px solid #999; flex-shrink: 0;
    }
    h4 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #ccc; padding-bottom: 5px; color: #333; }
  </style>
</head>
<body>

  <!-- POPUP CONTAINER -->
  <div id="hoverPopup"></div>

  <!-- MAIN CONTROLS -->
  <div id="controls">
    <div class="layer-row time-machine-row">
        <input type="checkbox" id="chkTimeMachine" onchange="toggleTimeMachine(this.checked)">
        <label for="chkTimeMachine">Time Machine</label>
    </div>
    <div class="layer-row">
        <input type="checkbox" id="chkLegend" checked onchange="toggleLegend(this.checked)">
        <label for="chkLegend">Show Legend</label>
    </div>
    <div id="loadingIndicator">Initializing...</div>
  </div>

  <div id="legendPanel"></div>
  <div id="cesiumContainer"></div>

  <script>
    // =========================================================
    // 1. DATA & CONSTANTS
    // =========================================================
    
    // Hardcoded Mask GeoJSON (WGS84)
    const maskGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { "name": "Norfolk Bounds" },
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [[0.2,52.8],[0.4,52.95],[0.8,53],[1.2,52.9],[1.7,52.7],[1.75,52.5],[1.4,52.35],[0.7,52.4],[0.2,52.6],[0.2,52.8]],
              [[0.609505,52.778295],[0.614859,52.777412],[0.615964,52.777471],[0.615739,52.776523],[0.61428,52.776484],[0.613743,52.774414],[0.618786,52.774044],[0.618067,52.770188],[0.618303,52.76965],[0.623163,52.771876],[0.6265,52.770305],[0.628034,52.772629],[0.627583,52.772765],[0.62768,52.773259],[0.62753,52.773538],[0.62798,52.7737],[0.627905,52.773972],[0.629032,52.774498],[0.630963,52.775141],[0.631971,52.775374],[0.630512,52.777179],[0.629965,52.777205],[0.628721,52.778723],[0.627369,52.778616],[0.627047,52.780495],[0.626843,52.78166],[0.625995,52.781666],[0.626623,52.782757],[0.629831,52.781871],[0.630008,52.78237],[0.630008,52.78336],[0.630206,52.784564],[0.628324,52.784878],[0.62835,52.785177],[0.631076,52.785141],[0.633634,52.785394],[0.632685,52.786601],[0.631869,52.787853],[0.634788,52.788314],[0.634857,52.7892],[0.634755,52.789459],[0.634793,52.789787],[0.635013,52.789943],[0.635249,52.79005],[0.635533,52.789878],[0.635351,52.792162],[0.636038,52.79246],[0.635877,52.79283],[0.636252,52.793024],[0.636531,52.79329],[0.637035,52.793219],[0.638098,52.79462],[0.636928,52.795444],[0.635158,52.796229],[0.633205,52.796781],[0.631135,52.797183],[0.630877,52.796366],[0.62813,52.796314],[0.62665,52.796534],[0.625834,52.797741],[0.623474,52.79778],[0.622959,52.795496],[0.620985,52.793368],[0.619268,52.787672],[0.618582,52.786426],[0.614033,52.782585],[0.609505,52.778295]]
            ]
          }
        }
      ]
    };

    const URLS = {
        LANDCOVERS: 'https://firebasestorage.googleapis.com/v0/b/naturecitynorwich.firebasestorage.app/o/HEDGEROW_MARATHON%2FMASSINGHAM_FARM_PARTNERSHIP%2Fsbi_landcovers_that_intersect_route_4326.geojson?alt=media&token=53725055-df03-4de6-ad4c-2568acca11c5',
        VEGETATION: 'https://firebasestorage.googleapis.com/v0/b/naturecitynorwich.firebasestorage.app/o/HEDGEROW_MARATHON%2FMASSINGHAM_FARM_PARTNERSHIP%2Fveg_on_parcels_that_intersect_route_4326.geojson?alt=media&token=f47ace15-22b0-4c95-860d-6563a2781913',
        ROUTE: 'https://firebasestorage.googleapis.com/v0/b/naturecitynorwich.firebasestorage.app/o/HEDGEROW_MARATHON%2FhedgerowMarathonSimpleLine_EPSG_3587.geojson?alt=media&token=3ece0637-a19d-4837-acaf-779f955be40e',
        HISTORIC_MAP: 'https://mapseries-tilesets.s3.amazonaws.com/os/six-inch-norfolk/{z}/{x}/{y}.png'
    };

    const landCoverColors = {
        'Arable Land': '#F0E68C', 'Permanent Grassland': '#32CD32', 'Woodland': '#228B22',
        'Natural Woodland': '#006400', 'Pond': '#4682B4', 'Rivers and streams type 3': '#1E90FF',
        'Drain/Ditch/Dyke': '#00BFFF', 'Farm Building': '#8B4513', 'Residential dwelling, House': '#CD5C5C',
        'Farmyards': '#D2B48C', 'Track - Natural Surface': '#DEB887', 'Metalled track': '#808080',
        'Residential Gardens': '#90EE90', 'Non-agricultural land': '#A9A9A9', 'Scrub - Ungrazeable': '#8FBC8F',
        'default': '#FFeda0'
    };

    proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs");

    const popupGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "description": "New Belt at the starte of the route. present as mixed (conifer and deciduous) woodland on the 1884 first edition OS six inch." }, "geometry": { "type": "Polygon", "coordinates": [[[0.618281,52.770201],[0.618743,52.769857],[0.62636,52.773531],[0.628871,52.774414],[0.628409,52.774673],[0.625191,52.773486],[0.619462,52.770682],[0.618281,52.770201]]] } },
        { "type": "Feature", "properties": { "description": "the plantation just north of new belt first appears on the 1952 OS six inch." }, "geometry": { "type": "Polygon", "coordinates": [[[0.618904,52.774174],[0.618753,52.773356],[0.624654,52.77346],[0.624397,52.774278],[0.618904,52.774174]]] } },
        { "type": "Feature", "properties": { "description": "planted in the 1980s" }, "geometry": { "type": "Polygon", "coordinates": [[[0.622895,52.781598],[0.623989,52.781611],[0.624611,52.778263],[0.623474,52.778172],[0.622895,52.781598]]] } },
        { "type": "Feature", "properties": { "description": "The triangular 'awkward corner' infill was planted around a marl pit in the early 2000's" }, "geometry": { "type": "Polygon", "coordinates": [[[0.622637,52.787931],[0.624011,52.788554],[0.624547,52.787892],[0.623453,52.787841],[0.622637,52.787931]]] } },
        { "type": "Feature", "properties": { "description": "The irregular shaped woodland to the east of the route at the north end of the estate is an old gravel pit that dates from the early 20th century - the google earth air photos indicate this area has been managed for wildlife since the early 2000s" }, "geometry": { "type": "Polygon", "coordinates": [[[0.626671,52.796521],[0.629117,52.796301],[0.63107,52.796314],[0.630791,52.795717],[0.63122,52.794549],[0.634611,52.794108],[0.634933,52.793265],[0.635619,52.792771],[0.634096,52.792668],[0.63328,52.793368],[0.63195,52.793446],[0.63077,52.793161],[0.628345,52.794004],[0.628967,52.79429],[0.628238,52.795587],[0.628002,52.795924],[0.626671,52.796521]]] } }
      ]
    };

    // =========================================================
    // 2. GLOBAL STATE
    // =========================================================
    let dsRPA, dsOutlines, dsCustom, dsMarathon, dsPopups, dsMask, layer1880s, currentSbiData;
    let isTimeMachineActive = false;

    // =========================================================
    // 3. VIEWER INITIALIZATION
    // =========================================================
    const viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: false, 
      baseLayerPicker: false,
      timeline: false,
      animation: false,
      scene3DOnly: true,
      infoBox: false, 
      selectionIndicator: false
    });

    viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
      url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
      subdomains: ['a', 'b', 'c', 'd'],
      credit: '© OpenStreetMap contributors, © CARTO'
    }));

    viewer.scene.msaaSamples = 4; 
    viewer.scene.postProcessStages.fxaa.enabled = true; 

    // Initialize Historic Map
    const historicProvider = new Cesium.UrlTemplateImageryProvider({
        url: URLS.HISTORIC_MAP,
        credit: '© National Library of Scotland / OS 1880s'
    });
    layer1880s = viewer.imageryLayers.addImageryProvider(historicProvider);
    layer1880s.show = false; 
    layer1880s.alpha = 1.0;

    // =========================================================
    // 4. MAIN DATA LOADING
    // =========================================================
    async function initData() {
      const loader = document.getElementById('loadingIndicator');
      loader.style.display = 'block';
      
      try {
        loader.innerText = "Loading annotations...";
        await loadPopupLayer(popupGeoJSON);

        loader.innerText = "Loading landcovers...";
        const landcoversResponse = await fetch(URLS.LANDCOVERS);
        const landcoversData = await landcoversResponse.json();
        await loadSbiData(landcoversData);

        loader.innerText = "Loading vegetation...";
        const vegResponse = await fetch(URLS.VEGETATION);
        const vegData = await vegResponse.json();
        await loadCustomData(vegData);

        loader.innerText = "Loading mask...";
        await loadMaskLayer();

        loader.innerText = "Loading route...";
        await loadMarathonRoute();

        loader.innerText = "Ready.";
        setTimeout(() => { loader.style.display = 'none'; }, 1000);

      } catch (err) {
        console.error("Load Error:", err);
        loader.innerText = "Error loading data.";
      }
    }

    async function loadPopupLayer(geojsonData) {
        const processedData = processGeoJSON(geojsonData, 0); 
        dsPopups = await Cesium.GeoJsonDataSource.load(processedData, {
            stroke: Cesium.Color.TRANSPARENT,
            fill: Cesium.Color.TRANSPARENT,
            clampToGround: false
        });

        const canvas = document.createElement('canvas');
        canvas.width = 64; canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#4facfe'; ctx.beginPath(); ctx.arc(32, 32, 28, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = 'white'; ctx.font = 'bold 40px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('i', 32, 34);

        const entities = dsPopups.entities.values;
        entities.forEach((entity, index) => {
            if (entity.polygon) entity.polygon.show = false; 

            let centroid;
            if (entity.polygon && entity.polygon.hierarchy) {
                const positions = entity.polygon.hierarchy.getValue().positions;
                centroid = Cesium.BoundingSphere.fromPoints(positions).center;
            }

            if (centroid) {
                const pinEntity = viewer.entities.add({
                    position: centroid,
                    billboard: {
                        image: canvas,
                        scale: 0.5,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        heightReference: Cesium.HeightReference.NONE
                    }
                });
                pinEntity.isPopupTarget = true;
                pinEntity.popupName = `Feature ${index + 1}`;
                if (entity.properties && entity.properties.description) {
                    pinEntity.popupDescription = entity.properties.description.getValue();
                }
            }
        });
        await viewer.dataSources.add(dsPopups);
    }

    async function loadSbiData(data) {
      const legend = document.getElementById('legendPanel');
      const processedData = processGeoJSON(data, 0); 
      currentSbiData = processedData;

      dsRPA = await Cesium.GeoJsonDataSource.load(processedData, { clampToGround: false });
      const entities = dsRPA.entities.values;
      const foundCategories = new Set();

      for (let i = 0; i < entities.length; i++) {
          const entity = entities[i];
          const desc = entity.properties.DESCRIPTION ? entity.properties.DESCRIPTION.getValue() : 'default';
          foundCategories.add(desc);
          
          const colorCss = landCoverColors[desc] || landCoverColors['default'];
          const baseColor = Cesium.Color.fromCssColorString(colorCss);
          const maxAlpha = (desc === 'Woodland' || desc === 'Natural Woodland') ? 1.0 : 0.6;

          if(entity.polygon) {
              entity.polygon.outline = false;
              entity.polygon.height = 0; 
              entity.polygon.extrudedHeight = undefined; 
              entity.polygon.material = new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(function() {
                  return isTimeMachineActive ? baseColor.withAlpha(0.0) : baseColor.withAlpha(maxAlpha);
              }, false));
          }
      }
      viewer.dataSources.add(dsRPA);

      const outlinesGeoJSON = { type: "FeatureCollection", features: [] };
      processedData.features.forEach(f => {
          if (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') {
              const lines = turf.polygonToLine(f);
              if (lines.type === 'FeatureCollection') outlinesGeoJSON.features.push(...lines.features);
              else outlinesGeoJSON.features.push(lines);
          }
      });
      dsOutlines = await Cesium.GeoJsonDataSource.load(outlinesGeoJSON, { clampToGround: false });
      const outlineEntities = dsOutlines.entities.values;
      for(let i=0; i<outlineEntities.length; i++) {
          if(outlineEntities[i].polyline) {
              outlineEntities[i].polyline.width = 1.0;
              outlineEntities[i].polyline.material = new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(function() {
                  return isTimeMachineActive ? Cesium.Color.BLACK.withAlpha(0.0) : Cesium.Color.BLACK;
              }, false));
          }
      }
      viewer.dataSources.add(dsOutlines);
      viewer.zoomTo(dsRPA);

      legend.innerHTML = '<h4>Land Cover</h4>';
      Array.from(foundCategories).sort().forEach(c => {
          const color = landCoverColors[c] || landCoverColors['default'];
          legend.innerHTML += `<div class="legend-item"><i style="background:${color}"></i><span>${c}</span></div>`;
      });
      if(document.getElementById('chkLegend').checked) legend.style.display = 'block';
    }

    async function loadCustomData(geojsonObject) {
      const processed = processGeoJSON(geojsonObject, 0); 
      dsCustom = await Cesium.GeoJsonDataSource.load(processed, { clampToGround: false });
      const entities = dsCustom.entities.values;
      const baseWoodlandColor = Cesium.Color.fromCssColorString(landCoverColors['Woodland']);

      for (let i = 0; i < entities.length; i++) {
        const entity = entities[i];
        if (entity.properties && entity.properties.height && entity.polygon) {
          const heightValue = entity.properties.height.getValue();
          entity.polygon.height = 0;
          entity.polygon.extrudedHeight = heightValue; 
          entity.polygon.outline = false; 
          entity.polygon.material = new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(function() {
              return isTimeMachineActive ? baseWoodlandColor.withAlpha(0.15) : baseWoodlandColor.withAlpha(1.0);
          }, false));
        }
      }
      viewer.dataSources.add(dsCustom);
    }
    
    // =========================================================================
    // LOAD MASK: HARD-CODED WGS84 GEOJSON + WORKING EXAMPLE LOGIC
    // =========================================================================
    async function loadMaskLayer() {
        // Use the constant 'maskGeoJSON' directly
        // Note: clampToGround: false allows manual height control via HeightReference
        dsMask = await Cesium.GeoJsonDataSource.load(maskGeoJSON, { 
            clampToGround: false 
        });
        
        const entities = dsMask.entities.values;
        const staticMaterial = Cesium.Color.WHITE.withAlpha(0.8);

        for (let i = 0; i < entities.length; i++) {
            const entity = entities[i];
            if (entity.polygon) {
                // Style: White, 80%
                entity.polygon.material = staticMaterial;
                entity.polygon.outline = false;

                // Height: Relative to Ground, 1 meter up
                // This pattern matches your working example
                entity.polygon.heightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
                entity.polygon.height = 1.0; 
            }
        }
        
        dsMask.show = false;
        viewer.dataSources.add(dsMask);
    }

    async function loadMarathonRoute() {
        try {
            const response = await fetch(URLS.ROUTE);
            const data = await response.json();
            const processedData = processGeoJSON(data, 30);
            dsMarathon = await Cesium.GeoJsonDataSource.load(processedData, { clampToGround: false });
            
            const entities = dsMarathon.entities.values;
            for (let i = 0; i < entities.length; i++) {
                if (entities[i].polyline) {
                    entities[i].polyline.width = 5;
                    entities[i].polyline.material = new Cesium.PolylineDashMaterialProperty({
                        color: Cesium.Color.RED,
                        gapColor: Cesium.Color.TRANSPARENT,
                        dashLength: 20
                    });
                }
            }
            viewer.dataSources.add(dsMarathon);
            
            const legend = document.getElementById('legendPanel');
            if(!legend.innerHTML.includes('<h4>Land Cover</h4>')) legend.innerHTML = '<h4>Legend</h4>' + legend.innerHTML;
            legend.innerHTML += `<div class="legend-item"><i style="border:none; border-bottom: 3px dashed yellow; background:none; height:10px; margin-top:5px;"></i><span>Marathon Route</span></div>`;
        } catch (error) { console.error(error); }
    }

    // =========================================================
    // 5. HELPER FUNCTIONS
    // =========================================================
    
    // REPROJECTION UTILITY
    function processGeoJSON(geojson, heightOffset = 0) {
        let cloned = JSON.parse(JSON.stringify(geojson));
        // Simple heuristic: if x coordinate > 180, assume BNG
        let isBNG = false;
        try {
            if (getFirstCoordinate(cloned.features[0].geometry)[0] > 180) isBNG = true;
        } catch(e) {}

        const transformFn = (coords) => {
            if (isBNG) {
                const wgs = proj4('EPSG:27700', 'EPSG:4326', coords);
                // Return [lon, lat, height]
                return [wgs[0], wgs[1], heightOffset];
            } else {
                return [coords[0], coords[1], heightOffset];
            }
        };

        const transformGeometry = (geometry) => {
            if (geometry.type === 'Polygon' || geometry.type === 'MultiLineString') {
                geometry.coordinates = geometry.coordinates.map(ring => ring.map(transformFn));
            } else if (geometry.type === 'MultiPolygon') {
                geometry.coordinates = geometry.coordinates.map(poly => poly.map(ring => ring.map(transformFn)));
            } else if (geometry.type === 'LineString') {
                geometry.coordinates = geometry.coordinates.map(transformFn);
            }
        };

        if (cloned.type === 'FeatureCollection') cloned.features.forEach(f => transformGeometry(f.geometry));
        else if (cloned.type === 'Feature') transformGeometry(cloned.geometry);
        return turf.rewind(cloned, {reverse: false, mutate: true});
    }

    function getFirstCoordinate(geometry) {
        if (geometry.type === 'Point') return geometry.coordinates;
        if (geometry.type === 'LineString' || geometry.type === 'MultiPoint') return geometry.coordinates[0];
        if (geometry.type === 'Polygon' || geometry.type === 'MultiLineString') return geometry.coordinates[0][0];
        if (geometry.type === 'MultiPolygon') return geometry.coordinates[0][0][0];
        return null;
    }

    // =========================================================
    // 6. INTERACTION HANDLERS
    // =========================================================
    
    function toggleTimeMachine(checked) {
        isTimeMachineActive = checked;
        
        if(layer1880s) layer1880s.show = isTimeMachineActive;
        if(dsMask) dsMask.show = isTimeMachineActive;

        viewer.scene.requestRender();
    }

    function toggleLegend(checked) {
        document.getElementById('legendPanel').style.display = (checked && currentSbiData) ? 'block' : 'none';
    }

    // Hover Handler
    const popup = document.getElementById('hoverPopup');
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement) {
      const pickedObject = viewer.scene.pick(movement.endPosition);
      if (Cesium.defined(pickedObject) && pickedObject.id instanceof Cesium.Entity) {
        const entity = pickedObject.id;
        if (entity.isPopupTarget) {
            const desc = entity.popupDescription || '';
            popup.innerHTML = `<strong>${entity.popupName}</strong>${desc}`;
            popup.style.display = 'block';
            popup.style.left = movement.endPosition.x + 'px';
            popup.style.top = movement.endPosition.y + 'px';
            viewer.container.style.cursor = 'pointer';
        } else {
            popup.style.display = 'none';
            viewer.container.style.cursor = 'default';
        }
      } else {
        popup.style.display = 'none';
        viewer.container.style.cursor = 'default';
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    window.addEventListener('load', initData);

  </script>
</body>
</html>
