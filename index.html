<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SBI: 3D Woodland Visualization</title>
  <!-- CesiumJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.110.0/Cesium.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.110.0/Widgets/widgets.css" rel="stylesheet">
  <!-- Proj4 for Coordinate Transformation -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
  <!-- Turf.js for Geometry Processing -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    body, html, #cesiumContainer { 
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; 
      background: #dcdcdc; font-family: sans-serif; 
    }

    /* --- POPUP STYLES --- */
    #hoverPopup {
      display: none;
      position: absolute;
      z-index: 1000;
      background: rgba(30, 30, 30, 0.9);
      color: #fff;
      padding: 10px 15px;
      border-radius: 6px;
      pointer-events: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 14px;
      max-width: 300px;
      line-height: 1.4;
      transform: translate(15px, 15px);
    }
    
    #hoverPopup strong {
      display: block;
      margin-bottom: 4px;
      color: #4facfe;
      font-size: 15px;
    }

    /* --- MAIN CONTROLS --- */
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 100;
      background: rgba(255, 255, 255, 0.95); padding: 12px; border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2); width: 240px;
    }

    button {
      padding: 8px; background-color: #333; color: white; border: none; 
      border-radius: 3px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 5px;
    }
    button:hover { background-color: #555; }
    
    select {
        width: 100%; padding: 6px; margin-bottom: 8px; border-radius: 3px; border: 1px solid #ccc;
    }

    input[type="file"] { display: none; }

    .layer-row { display: flex; align-items: center; font-size: 13px; cursor: pointer; margin-bottom: 5px; color: #333; flex-wrap: wrap; }
    .layer-row input[type="checkbox"] { margin-right: 8px; cursor: pointer; }
    
    /* New Time Machine Styles */
    .time-machine-row {
        background-color: #f0f8ff;
        border: 1px solid #4682b4;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    .time-machine-row label {
        font-weight: bold;
        color: #000;
    }

    #loadingIndicator { 
        font-size: 11px; color: #666; margin-top: 5px; display: none; font-style: italic; 
    }

    /* --- LEGEND --- */
    #legendPanel {
      position: absolute; bottom: 30px; right: 10px;
      background: rgba(255, 255, 255, 0.95); padding: 10px;
      border-radius: 5px; z-index: 100; max-height: 400px;
      overflow-y: auto; width: 220px; display: none;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }
    .legend-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 12px; color: #333; }
    .legend-item i {
      width: 18px; height: 18px; float: left; margin-right: 8px;
      opacity: 0.8; border: 1px solid #999; flex-shrink: 0;
    }
    h4 { margin: 0 0 10px 0; font-size: 14px; border-bottom: 1px solid #ccc; padding-bottom: 5px; color: #333; }

    .separator { border-top: 1px solid #ddd; margin: 10px 0; }
  </style>
</head>
<body>

  <!-- POPUP CONTAINER -->
  <div id="hoverPopup"></div>

  <!-- CONTROLS CONTAINER -->
  <div id="controls">
    <label style="font-size:12px; font-weight:bold; color:#333;">Data Loading:</label>
    <button onclick="loadDatasets()" style="background-color: #228B22;">Load All Data</button>

    <div class="separator"></div>
    
    <!-- Time Machine Checkbox -->
    <div class="layer-row time-machine-row">
        <input type="checkbox" id="chkTimeMachine" onchange="toggleTimeMachine(this.checked)">
        <label for="chkTimeMachine">Time Machine</label>
    </div>

    <div class="layer-row">
        <input type="checkbox" id="chkLegend" checked onchange="toggleLegend(this.checked)">
        <label for="chkLegend">Show Legend</label>
    </div>

    <div class="separator"></div>
    <label style="font-size:12px; font-weight:bold; color:#333;">Saved Views:</label>
    <select id="viewSelector" onchange="restoreView(this.value)">
        <option value="">-- Select a View --</option>
    </select>
    
    <div style="display:flex; gap:5px;">
        <button onclick="addCurrentView()" style="background-color: #5F9EA0; flex:1;">+ Add</button>
        <button onclick="downloadViews()" style="background-color: #5F9EA0; flex:1;">Save File</button>
    </div>
    
    <input type="file" id="settingsInput" accept=".txt, .json" onchange="loadViewsFile(event)">
    <button onclick="document.getElementById('settingsInput').click()" style="background-color: #708090;">Import Views File</button>

    <div id="loadingIndicator"></div>
  </div>

  <div id="legendPanel"></div>
  <div id="cesiumContainer"></div>

  <script>
    // =========================================================
    // 1. DATA CONSTANTS
    // =========================================================
    const LANDCOVERS_URL = 'https://firebasestorage.googleapis.com/v0/b/naturecitynorwich.firebasestorage.app/o/HEDGEROW_MARATHON%2FMASSINGHAM_FARM_PARTNERSHIP%2Fsbi_landcovers_that_intersect_route_4326.geojson?alt=media&token=53725055-df03-4de6-ad4c-2568acca11c5';
    const VEG_URL = 'https://firebasestorage.googleapis.com/v0/b/naturecitynorwich.firebasestorage.app/o/HEDGEROW_MARATHON%2FMASSINGHAM_FARM_PARTNERSHIP%2Fveg_on_parcels_that_intersect_route_4326.geojson?alt=media&token=f47ace15-22b0-4c95-860d-6563a2781913';
    const MARATHON_URL = 'https://firebasestorage.googleapis.com/v0/b/naturecitynorwich.firebasestorage.app/o/HEDGEROW_MARATHON%2FhedgerowMarathonSimpleLine_EPSG_3587.geojson?alt=media&token=3ece0637-a19d-4837-acaf-779f955be40e';
    const OS_1880_URL = 'https://mapseries-tilesets.s3.amazonaws.com/os/six-inch-norfolk/{z}/{x}/{y}.png';

    const sampleGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "description": "New Belt at the starte of the route. present as mixed (conifer and deciduous) woodland on the 1884 first edition OS six inch." }, "geometry": { "type": "Polygon", "coordinates": [[[0.618281,52.770201],[0.618743,52.769857],[0.62636,52.773531],[0.628871,52.774414],[0.628409,52.774673],[0.625191,52.773486],[0.619462,52.770682],[0.618281,52.770201]]] } },
        { "type": "Feature", "properties": { "description": "the plantation just north of new belt first appears on the 1952 OS six inch." }, "geometry": { "type": "Polygon", "coordinates": [[[0.618904,52.774174],[0.618753,52.773356],[0.624654,52.77346],[0.624397,52.774278],[0.618904,52.774174]]] } },
        { "type": "Feature", "properties": { "description": "planted in the 1980s" }, "geometry": { "type": "Polygon", "coordinates": [[[0.622895,52.781598],[0.623989,52.781611],[0.624611,52.778263],[0.623474,52.778172],[0.622895,52.781598]]] } },
        { "type": "Feature", "properties": { "description": "The triangular 'awkward corner' infill was planted around a marl pit in the early 2000's" }, "geometry": { "type": "Polygon", "coordinates": [[[0.622637,52.787931],[0.624011,52.788554],[0.624547,52.787892],[0.623453,52.787841],[0.622637,52.787931]]] } },
        { "type": "Feature", "properties": { "description": "The irregular shaped woodland to the east of the route at the north end of the estate is an old gravel pit that dates from the early 20th century - the google earth air photos indicate this area has been managed for wildlife since the early 2000s" }, "geometry": { "type": "Polygon", "coordinates": [[[0.626671,52.796521],[0.629117,52.796301],[0.63107,52.796314],[0.630791,52.795717],[0.63122,52.794549],[0.634611,52.794108],[0.634933,52.793265],[0.635619,52.792771],[0.634096,52.792668],[0.63328,52.793368],[0.63195,52.793446],[0.63077,52.793161],[0.628345,52.794004],[0.628967,52.79429],[0.628238,52.795587],[0.628002,52.795924],[0.626671,52.796521]]] } }
      ]
    };

    // Definitions
    proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs");

    const landCoverColors = {
        'Arable Land': '#F0E68C', 'Permanent Grassland': '#32CD32', 'Woodland': '#228B22',
        'Natural Woodland': '#006400', 'Pond': '#4682B4', 'Rivers and streams type 3': '#1E90FF',
        'Drain/Ditch/Dyke': '#00BFFF', 'Farm Building': '#8B4513', 'Residential dwelling, House': '#CD5C5C',
        'Farmyards': '#D2B48C', 'Track - Natural Surface': '#DEB887', 'Metalled track': '#808080',
        'Residential Gardens': '#90EE90', 'Non-agricultural land': '#A9A9A9', 'Scrub - Ungrazeable': '#8FBC8F',
        'default': '#FFeda0'
    };

    // =========================================================
    // 2. VIEWER INITIALIZATION
    // =========================================================
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: undefined,
      baseLayerPicker: false,
      timeline: false,
      animation: false,
      scene3DOnly: true,
      infoBox: false, 
      selectionIndicator: false,
      baseLayer: new Cesium.ImageryLayer(new Cesium.UrlTemplateImageryProvider({
        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
        subdomains: ['a', 'b', 'c', 'd'],
        credit: '© OpenStreetMap contributors, © CARTO'
      }))
    });

    viewer.scene.msaaSamples = 4; 
    viewer.scene.postProcessStages.fxaa.enabled = true; 

    // Global State
    let dsRPA = null;
    let dsOutlines = null;
    let dsCustom = null; 
    let dsMarathon = null;
    let dsPopups = null;
    let currentSbiData = null; 
    let layer1880s = null;
    let savedViews = [];
    
    // Time Machine State (Boolean)
    let isTimeMachineActive = false;

    // =========================================================
    // 3. LAYER MANAGEMENT (Historic Map & Time Machine)
    // =========================================================
    function init1880sLayer() {
        const provider = new Cesium.UrlTemplateImageryProvider({
            url: OS_1880_URL,
            credit: '© National Library of Scotland / OS 1880s'
        });
        layer1880s = viewer.imageryLayers.addImageryProvider(provider);
        // Initially hidden (Time Machine unchecked)
        layer1880s.show = false; 
        layer1880s.alpha = 1.0;
    }
    init1880sLayer();

    function toggleTimeMachine(checked) {
        isTimeMachineActive = checked;
        
        // 1. Toggle 1880s Layer Visibility
        if(layer1880s) {
            layer1880s.show = isTimeMachineActive;
            layer1880s.alpha = 1.0; // Max opacity as requested
        }
        
        // 2. Trigger updates for Vectors via CallbackProperties
        viewer.scene.requestRender();
    }

    // =========================================================
    // 4. DATA LOADING FUNCTIONS
    // =========================================================
    
    // --- Master Load Function ---
    async function loadDatasets() {
      const loader = document.getElementById('loadingIndicator');
      loader.style.display = 'block';
      
      try {
        loader.innerText = "Loading annotations...";
        await loadPopupLayer(sampleGeoJSON);

        loader.innerText = "Loading landcovers...";
        const landcoversResponse = await fetch(LANDCOVERS_URL);
        const landcoversData = await landcoversResponse.json();
        await loadSbiData(landcoversData);

        loader.innerText = "Loading vegetation...";
        const vegResponse = await fetch(VEG_URL);
        const vegData = await vegResponse.json();
        await loadCustomData(vegData);

        loader.innerText = "Loading marathon route...";
        await loadMarathonRoute();

        loader.innerText = "All data loaded successfully!";
        setTimeout(() => { loader.style.display = 'none'; }, 2000);

      } catch (err) {
        console.error("Load Error:", err);
        alert("Error loading data: " + err.message);
        loader.innerText = "Error loading data.";
      }
    }

    // --- A. Load Popup Layer ---
    async function loadPopupLayer(geojsonData) {
        if (dsPopups) viewer.dataSources.remove(dsPopups);

        const processedData = processGeoJSON(geojsonData, 30); 
        dsPopups = await Cesium.GeoJsonDataSource.load(processedData, {
            stroke: Cesium.Color.TRANSPARENT,
            strokeWidth: 0,
            fill: Cesium.Color.TRANSPARENT,
            clampToGround: false
        });

        const entities = dsPopups.entities.values;
        const canvas = document.createElement('canvas');
        canvas.width = 64; canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#4facfe'; ctx.beginPath(); ctx.arc(32, 32, 28, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = 'white'; ctx.font = 'bold 40px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('i', 32, 34);

        entities.forEach((entity, index) => {
            if (entity.polygon) {
                entity.polygon.material = Cesium.Color.TRANSPARENT;
                entity.polygon.outline = false;
            }

            let centroid;
            if (entity.polygon && entity.polygon.hierarchy) {
                const positions = entity.polygon.hierarchy.getValue().positions;
                centroid = Cesium.BoundingSphere.fromPoints(positions).center;
            }

            if (centroid) {
                const pinEntity = viewer.entities.add({
                    position: centroid,
                    billboard: {
                        image: canvas,
                        scale: 0.5,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        heightReference: Cesium.HeightReference.NONE
                    }
                });
                pinEntity.isPopupTarget = true;
                pinEntity.popupName = `Feature ${index + 1}`;
                if (entity.properties && entity.properties.description) {
                    pinEntity.popupDescription = entity.properties.description.getValue();
                }
            }
        });
        await viewer.dataSources.add(dsPopups);
    }

    // --- B. Load SBI Data (Landcover) ---
    async function loadSbiData(data) {
      const legend = document.getElementById('legendPanel');
      if(dsRPA) viewer.dataSources.remove(dsRPA);
      if(dsOutlines) viewer.dataSources.remove(dsOutlines);
      
      const processedData = processGeoJSON(data); 
      currentSbiData = processedData;

      dsRPA = await Cesium.GeoJsonDataSource.load(processedData, { clampToGround: false });
      const entities = dsRPA.entities.values;
      const foundCategories = new Set();

      for (let i = 0; i < entities.length; i++) {
          const entity = entities[i];
          const desc = entity.properties.DESCRIPTION ? entity.properties.DESCRIPTION.getValue() : 'default';
          foundCategories.add(desc);
          const colorCss = landCoverColors[desc] || landCoverColors['default'];
          const baseColor = Cesium.Color.fromCssColorString(colorCss);
          
          const maxAlpha = (desc === 'Woodland' || desc === 'Natural Woodland') ? 1.0 : 0.6;

          if(entity.polygon) {
              entity.polygon.outline = false;
              entity.polygon.height = 2;
              entity.polygon.extrudedHeight = undefined;
              
              // CALLBACK PROPERTY FOR PERFORMANCE
              entity.polygon.material = new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(function() {
                  // If Time Machine ON: Hide (Alpha 0)
                  // If Time Machine OFF: Show (Normal Alpha)
                  return isTimeMachineActive ? baseColor.withAlpha(0.0) : baseColor.withAlpha(maxAlpha);
              }, false));
          }
      }
      viewer.dataSources.add(dsRPA);

      // Outlines
      const outlinesGeoJSON = { type: "FeatureCollection", features: [] };
      processedData.features.forEach(f => {
          if (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') {
              const lines = turf.polygonToLine(f);
              if (lines.type === 'FeatureCollection') outlinesGeoJSON.features.push(...lines.features);
              else outlinesGeoJSON.features.push(lines);
          }
      });
      dsOutlines = await Cesium.GeoJsonDataSource.load(outlinesGeoJSON, { clampToGround: false });
      const outlineEntities = dsOutlines.entities.values;
      for(let i=0; i<outlineEntities.length; i++) {
          if(outlineEntities[i].polyline) {
              outlineEntities[i].polyline.width = 1.0;
              // Hide outlines when Time Machine is ON
              outlineEntities[i].polyline.material = new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(function() {
                  return isTimeMachineActive ? Cesium.Color.BLACK.withAlpha(0.0) : Cesium.Color.BLACK;
              }, false));
          }
      }
      viewer.dataSources.add(dsOutlines);
      viewer.zoomTo(dsRPA);

      legend.innerHTML = '<h4>Land Cover</h4>';
      Array.from(foundCategories).sort().forEach(c => {
          const color = landCoverColors[c] || landCoverColors['default'];
          legend.innerHTML += `<div class="legend-item"><i style="background:${color}"></i><span>${c}</span></div>`;
      });
      if(document.getElementById('chkLegend').checked) legend.style.display = 'block';
    }

    // --- C. Load Veg Data (Vegetation) ---
    async function loadCustomData(geojsonObject) {
      if(dsCustom) viewer.dataSources.remove(dsCustom);
      dsCustom = await Cesium.GeoJsonDataSource.load(geojsonObject, { clampToGround: false });
      const entities = dsCustom.entities.values;
      const baseWoodlandColor = Cesium.Color.fromCssColorString(landCoverColors['Woodland']);

      for (let i = 0; i < entities.length; i++) {
        const entity = entities[i];
        if (entity.properties && entity.properties.height && entity.polygon) {
          const heightValue = entity.properties.height.getValue();
          entity.polygon.height = 2;
          entity.polygon.extrudedHeight = heightValue + 2; 
          entity.polygon.outline = false; 

          // CALLBACK PROPERTY FOR PERFORMANCE
          entity.polygon.material = new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(function() {
              // If Time Machine ON: 85% Transparent (Alpha 0.15)
              // If Time Machine OFF: 100% Opaque (Alpha 1.0)
              return isTimeMachineActive ? baseWoodlandColor.withAlpha(0.15) : baseWoodlandColor.withAlpha(1.0);
          }, false));
        }
      }
      viewer.dataSources.add(dsCustom);
    }

    // --- D. Load Marathon Route (Always Visible) ---
    async function loadMarathonRoute() {
        if(dsMarathon) viewer.dataSources.remove(dsMarathon);
        try {
            const response = await fetch(MARATHON_URL);
            const data = await response.json();
            const processedData = processGeoJSON(data, 30);
            dsMarathon = await Cesium.GeoJsonDataSource.load(processedData, { clampToGround: false });
            
            const entities = dsMarathon.entities.values;
            for (let i = 0; i < entities.length; i++) {
                if (entities[i].polyline) {
                    entities[i].polyline.width = 5;
                    entities[i].polyline.material = new Cesium.PolylineDashMaterialProperty({
                        color: Cesium.Color.RED,
                        gapColor: Cesium.Color.TRANSPARENT,
                        dashLength: 20
                    });
                }
            }
            viewer.dataSources.add(dsMarathon);
            
            const legend = document.getElementById('legendPanel');
            if(!legend.innerHTML.includes('<h4>Land Cover</h4>')) legend.innerHTML = '<h4>Legend</h4>' + legend.innerHTML;
            legend.innerHTML += `<div class="legend-item"><i style="border:none; border-bottom: 3px dashed yellow; background:none; height:10px; margin-top:5px;"></i><span>Marathon Route</span></div>`;
        } catch (error) { console.error(error); }
    }

    // =========================================================
    // 5. HELPER FUNCTIONS & VIEW MANAGEMENT
    // =========================================================
    function processGeoJSON(geojson, heightOffset = 2) {
        let cloned = JSON.parse(JSON.stringify(geojson));
        let isBNG = false;
        try {
            if (getFirstCoordinate(cloned.features[0].geometry)[0] > 180) isBNG = true;
        } catch(e) {}

        const transformFn = (coords) => {
            if (isBNG) {
                const wgs = proj4('EPSG:27700', 'EPSG:4326', coords);
                return [wgs[0], wgs[1], heightOffset];
            } else {
                return [coords[0], coords[1], heightOffset];
            }
        };

        const transformGeometry = (geometry) => {
            if (geometry.type === 'Polygon' || geometry.type === 'MultiLineString') {
                geometry.coordinates = geometry.coordinates.map(ring => ring.map(transformFn));
            } else if (geometry.type === 'MultiPolygon') {
                geometry.coordinates = geometry.coordinates.map(poly => poly.map(ring => ring.map(transformFn)));
            } else if (geometry.type === 'LineString') {
                geometry.coordinates = geometry.coordinates.map(transformFn);
            }
        };

        if (cloned.type === 'FeatureCollection') cloned.features.forEach(f => transformGeometry(f.geometry));
        else if (cloned.type === 'Feature') transformGeometry(cloned.geometry);
        return turf.rewind(cloned, {reverse: false, mutate: true});
    }

    function getFirstCoordinate(geometry) {
        if (geometry.type === 'Point') return geometry.coordinates;
        if (geometry.type === 'LineString' || geometry.type === 'MultiPoint') return geometry.coordinates[0];
        if (geometry.type === 'Polygon' || geometry.type === 'MultiLineString') return geometry.coordinates[0][0];
        if (geometry.type === 'MultiPolygon') return geometry.coordinates[0][0][0];
        return null;
    }

    function toggleLegend(checked) {
        document.getElementById('legendPanel').style.display = (checked && currentSbiData) ? 'block' : 'none';
    }

    function captureCurrentState(name) {
        const p = viewer.camera.positionCartographic;
        return {
            name: name,
            view: { lon: Cesium.Math.toDegrees(p.longitude), lat: Cesium.Math.toDegrees(p.latitude), h: p.height, head: Cesium.Math.toDegrees(viewer.camera.heading), pitch: Cesium.Math.toDegrees(viewer.camera.pitch), roll: Cesium.Math.toDegrees(viewer.camera.roll) },
            // Save Time Machine Boolean
            timeMachineActive: document.getElementById('chkTimeMachine').checked,
            legend: document.getElementById('chkLegend').checked
        };
    }

    function addCurrentView() {
        const name = prompt("View Name:", "View " + (savedViews.length + 1));
        if(name) { savedViews.push(captureCurrentState(name)); updateViewDropdown(); }
    }

    function updateViewDropdown() {
        const s = document.getElementById('viewSelector');
        s.innerHTML = '<option value="">-- Select --</option>';
        savedViews.forEach((v, i) => { const o = document.createElement('option'); o.value = i; o.innerText = v.name; s.appendChild(o); });
    }

    function downloadViews() {
        const b = new Blob([JSON.stringify(savedViews, null, 2)], {type: "text/plain;charset=utf-8"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = "views.json"; a.click();
    }

    function loadViewsFile(e) {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            try {
                const j = JSON.parse(ev.target.result);
                savedViews = savedViews.concat(Array.isArray(j) ? j : [j]);
                updateViewDropdown();
                alert("Views loaded");
            } catch(x){ alert("Invalid file"); }
        };
        r.readAsText(f);
    }

    function restoreView(i) {
        if(i==="") return;
        const s = savedViews[i];
        viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(s.view.lon, s.view.lat, s.view.h), orientation: { heading: Cesium.Math.toRadians(s.view.head), pitch: Cesium.Math.toRadians(s.view.pitch), roll: Cesium.Math.toRadians(s.view.roll) }});
        
        // Restore Time Machine State
        if (s.timeMachineActive !== undefined) {
            const chk = document.getElementById('chkTimeMachine');
            chk.checked = s.timeMachineActive;
            toggleTimeMachine(s.timeMachineActive);
        }
    }

    window.addEventListener('load', () => { loadDatasets(); });

    // =========================================================
    // 6. POPUP HANDLER
    // =========================================================
    const popup = document.getElementById('hoverPopup');
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

    handler.setInputAction(function(movement) {
      const pickedObject = viewer.scene.pick(movement.endPosition);

      if (Cesium.defined(pickedObject) && pickedObject.id instanceof Cesium.Entity) {
        const entity = pickedObject.id;

        if (entity.isPopupTarget) {
            const desc = entity.popupDescription || '';
            popup.innerHTML = `<strong>${entity.popupName}</strong>${desc}`;
            popup.style.display = 'block';
            popup.style.left = movement.endPosition.x + 'px';
            popup.style.top = movement.endPosition.y + 'px';
            viewer.container.style.cursor = 'pointer';
        } else {
            popup.style.display = 'none';
            viewer.container.style.cursor = 'default';
        }

      } else {
        popup.style.display = 'none';
        viewer.container.style.cursor = 'default';
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

  </script>
</body>
</html>
